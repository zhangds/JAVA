function GooFlow(t,e){0<navigator.userAgent.indexOf("MSIE 8.0")||0<navigator.userAgent.indexOf("MSIE 7.0")||0<navigator.userAgent.indexOf("MSIE 6.0")?GooFlow.prototype.useSVG="":GooFlow.prototype.useSVG="1",this.$id=t.attr("id"),this.$bgDiv=t,this.$bgDiv.addClass("GooFlow"),GooFlow.prototype.color.font&&this.$bgDiv.css("color",GooFlow.prototype.color.font);var o=(e.width||800)-2,i=(e.height||500)-2;this.$bgDiv.css({width:o+"px",height:i+"px"}),this.$tool=null,this.$head=null,this.$title="newFlow_1",this.$nodeRemark={},this.$nowType="cursor",this.$lineData={},this.$lineCount=0,this.$nodeData={},this.$nodeCount=0,this.$areaData={},this.$areaCount=0,this.$lineDom={},this.$nodeDom={},this.$areaDom={},this.$max=e.initNum||1,this.$focus="",this.$cursor="default",this.$editable=!1,this.$deletedItem={};var a=0,s="";if(e.haveHead){s="<div class='GooFlow_head' "+(GooFlow.prototype.color.main?"style='border-bottom-color:"+GooFlow.prototype.color.main+"'":"")+">",e.headLabel&&(s+="<label title='"+(e.initLabelText||"newFlow_1")+"' "+(GooFlow.prototype.color.main?"style='background:"+GooFlow.prototype.color.main+"'":"")+">"+(e.initLabelText||"newFlow_1")+"</label>");for(var r=0;r<e.headBtns.length;++r)s+="<a href='javascript:void(0)' class='GooFlow_head_btn'><i class='ico_"+e.headBtns[r]+"'></i></a>";s+="</div>",this.$head=$(s),this.$bgDiv.append(this.$head),a=24,this.onBtnNewClick=null,this.onBtnOpenClick=null,this.onBtnSaveClick=null,this.onFreshClick=null,e.headBtns&&this.$head.on("click",{inthis:this},function(t){t||(t=window.event);var e=t.target;if("DIV"!=e.tagName&&"SPAN"!=e.tagName){"a"==e.tagName&&(e=e.childNode[0]);var o=t.data.inthis;switch($(e).attr("class")){case"ico_new":null!=o.onBtnNewClick&&o.onBtnNewClick();break;case"ico_open":null!=o.onBtnOpenClick&&o.onBtnOpenClick();break;case"ico_save":null!=o.onBtnSaveClick&&o.onBtnSaveClick();break;case"ico_undo":o.undo();break;case"ico_redo":o.redo();break;case"ico_reload":null!=o.onFreshClick&&o.onFreshClick()}}})}var n=0;if(e.haveTool){if(this.$bgDiv.append("<div class='GooFlow_tool'"+(e.haveHead?"":" style='margin-top:3px'")+"><div style='height:"+(i-a-(e.haveHead?7:10))+"px' class='GooFlow_tool_div'></div></div>"),this.$tool=this.$bgDiv.find(".GooFlow_tool div"),this.$tool.append("<a href='javascript:void(0)' type='cursor' class='GooFlow_tool_btndown' id='"+this.$id+"_btn_cursor'><i class='ico_cursor'/></a><a href='javascript:void(0)' type='mutiselect' class='GooFlow_tool_btn' id='"+this.$id+"_btn_mutiselect'><i class='ico_mutiselect'/></a><a href='javascript:void(0)' type='direct' class='GooFlow_tool_btn' id='"+this.$id+"_btn_direct'><i class='ico_direct'/></a>"),e.toolBtns&&0<e.toolBtns.length){s="<span/>";for(var l=0;l<e.toolBtns.length;++l)s+="<a href='javascript:void(0)' type='"+e.toolBtns[l]+"' id='"+this.$id+"_btn_"+e.toolBtns[l].split(" ")[0]+"' class='GooFlow_tool_btn'><i class='ico_"+e.toolBtns[l]+"'/></a>";this.$tool.append(s)}e.haveGroup&&this.$tool.append("<span/><a href='javascript:void(0)' type='group' class='GooFlow_tool_btn' id='"+this.$id+"_btn_group'><i class='ico_group'/></a>"),n=31,this.$nowType="cursor",this.$tool.on("click",{inthis:this},function(t){var e;switch(t||(t=window.event),t.target.tagName){case"SPAN":case"DIV":return!1;case"I":e=t.target.parentNode;break;case"A":e=t.target}var o=$(e).attr("type");return t.data.inthis.switchToolBtn(o),!1}),this.$editable=!0}o=o-n-9,i=i-a-(e.haveHead?5:8),this.$bgDiv.append("<div class='GooFlow_work' style='width:"+o+"px;height:"+i+"px;"+(e.haveHead?"":"margin-top:3px")+"'></div>"),this.$workArea=$("<div class='GooFlow_work_inner' style='width:"+3*o+"px;height:"+3*i+"px'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"}),this.$bgDiv.children(".GooFlow_work").append(this.$workArea),this.$draw=null,this.initDraw("draw_"+this.$id,o,i),this.$group=null,e.haveGroup&&this.initGroup(o,i),this.$editable&&(this.$workArea.on("click",{inthis:this},function(t){t||(t=window.event);var e=t.data.inthis;if(e.$editable){var o=e.$nowType;if("cursor"!=o){if("direct"!=o&&"group"!=o){var i,a,s=mousePosition(t);r=getElCoordinate(this);i=s.x-r.left+this.parentNode.scrollLeft-1,a=s.y-r.top+this.parentNode.scrollTop-1,e.addNode(e.$id+"_node_"+e.$max,{name:"node_"+e.$max,left:i,top:a,type:e.$nowType}),e.$max++}}else{var r,n=(r=$(t.target)).prop("tagName");("svg"==n||"DIV"==n&&-1<r.prop("class").indexOf("GooFlow_work")||"LABEL"==n)&&(e.$lineOper.data("tid")?e.focusItem(e.$lineOper.data("tid"),!1):e.blurItem())}}}),this.$workArea.mousemove({inthis:this},function(t){if("direct"==t.data.inthis.$nowType||t.data.inthis.$mpTo.data("p")){var e=$(this).data("lineStart"),o=$(this).data("lineEnd");if(e||o){var i,a,s=mousePosition(t),r=getElCoordinate(this);i=s.x-r.left+this.parentNode.scrollLeft,a=s.y-r.top+this.parentNode.scrollTop;var n=document.getElementById("GooFlow_tmp_line");e?""!=GooFlow.prototype.useSVG?(n.childNodes[0].setAttribute("d","M "+e.x+" "+e.y+" L "+i+" "+a),n.childNodes[1].setAttribute("d","M "+e.x+" "+e.y+" L "+i+" "+a),'url("#arrow2")'==n.childNodes[1].getAttribute("marker-end")?n.childNodes[1].setAttribute("marker-end","url(#arrow3)"):n.childNodes[1].setAttribute("marker-end","url(#arrow2)")):n.points.value=e.x+","+e.y+" "+i+","+a:o&&(""!=GooFlow.prototype.useSVG?(n.childNodes[0].setAttribute("d","M "+i+" "+a+" L "+o.x+" "+o.y),n.childNodes[1].setAttribute("d","M "+i+" "+a+" L "+o.x+" "+o.y),'url("#arrow2")'==n.childNodes[1].getAttribute("marker-end")?n.childNodes[1].setAttribute("marker-end","url(#arrow3)"):n.childNodes[1].setAttribute("marker-end","url(#arrow2)")):n.points.value=i+","+a+" "+o.x+","+o.y)}}}),this.$workArea.mouseup({inthis:this},function(t){var e=t.data.inthis;if("direct"==e.$nowType||e.$mpTo.data("p")){var o=document.getElementById("GooFlow_tmp_line");o?($(this).css("cursor","auto").removeData("lineStart").removeData("lineEnd"),e.$mpTo.hide().removeData("p"),e.$mpFrom.hide().removeData("p"),e.$draw.removeChild(o),e.focusItem(e.$focus,!1)):e.$lineOper.removeData("tid")}}),this.initWorkForNode(),this.$ghost=$("<div class='rs_ghost'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"}),this.$bgDiv.append(this.$ghost),this.$textArea=$("<textarea></textarea>"),this.$bgDiv.append(this.$textArea),this.$lineMove=$("<div class='GooFlow_line_move' style='display:none'></div>"),this.$workArea.append(this.$lineMove),this.$lineMove.on("mousedown",{inthis:this},function(t){if(2==t.button)return!1;$(this).css({"background-color":GooFlow.prototype.color.font||"#333"});var o,i,a=t.data.inthis,e=mousePosition(t),s=getElCoordinate(a.$workArea[0]);o=e.x-s.left+a.$workArea[0].parentNode.scrollLeft,i=e.y-s.top+a.$workArea[0].parentNode.scrollTop;var r=a.$lineMove.position(),n=o-r.left,l=i-r.top,d=!1;document.onmousemove=function(t){t||(t=window.event);var e=mousePosition(t);a.$lineMove.position();o=e.x-s.left+a.$workArea[0].parentNode.scrollLeft,i=e.y-s.top+a.$workArea[0].parentNode.scrollTop,"lr"==a.$lineMove.data("type")?((o-=n)<0?o=0:o>a.$workArea.width()&&(o=a.$workArea.width()),a.$lineMove.css({left:o+"px"})):"tb"==a.$lineMove.data("type")&&((i-=l)<0?i=0:i>a.$workArea.height()&&(i=a.$workArea.height()),a.$lineMove.css({top:i+"px"})),d=!0},document.onmouseup=function(t){if(d){var e=a.$lineMove.position();"lr"==a.$lineMove.data("type")?a.setLineM(a.$lineMove.data("tid"),e.left+3):"tb"==a.$lineMove.data("type")&&a.setLineM(a.$lineMove.data("tid"),e.top+3)}a.$lineMove.css({"background-color":"transparent"}),a.$focus==a.$lineMove.data("tid")&&a.focusItem(a.$lineMove.data("tid")),document.onmousemove=null,document.onmouseup=null}}),this.$lineOper=$("<div class='GooFlow_line_oper' style='display:none'><i class='b_l1'></i><i class='b_l2'></i><i class='b_l3'></i><i class='b_x'></i></div>"),this.$workArea.parent().append(this.$lineOper),this.$lineOper.on("click",{inthis:this},function(t){if(t||(t=window.event),"I"==t.target.tagName){var e=t.data.inthis,o=$(this).data("tid");switch($(t.target).attr("class")){case"b_x":e.delLine(o),this.style.display="none";break;case"b_l1":e.setLineType(o,"lr");break;case"b_l2":e.setLineType(o,"tb");break;case"b_l3":e.setLineType(o,"sl")}}}),this.$mpFrom=$("<div class='GooFlow_line_mp' style='display:none'></div>"),this.$mpTo=$("<div class='GooFlow_line_mp' style='display:none'></div>"),this.$workArea.append(this.$mpFrom).append(this.$mpTo),this.initLinePointsChg(),this.onItemAdd=null,this.onItemDel=null,this.onItemMove=null,this.onItemRename=null,this.onItemFocus=null,this.onItemBlur=null,this.onItemResize=null,this.onLineMove=null,this.onLineSetType=null,this.onLinePointMove=null,this.onItemMark=null,e.useOperStack&&this.$editable&&(this.$undoStack=[],this.$redoStack=[],this.$isUndo=0,this.pushOper=function(t,e){this.$undoStack.length;1==this.$isUndo?(this.$redoStack.push([t,e]),this.$isUndo=!1,40<this.$redoStack.length&&this.$redoStack.shift()):(this.$undoStack.push([t,e]),40<this.$undoStack.length&&this.$undoStack.shift(),0==this.$isUndo&&this.$redoStack.splice(0,this.$redoStack.length),this.$isUndo=0)},this.pushExternalOper=function(t,e){this.pushOper("externalFunc",[t,e])},this.undo=function(){if(0!=this.$undoStack.length){this.blurItem();var t=this.$undoStack.pop();if(this.$isUndo=1,"externalFunc"==t[0])t[1][0](t[1][1]);else switch(t[1].length){case 0:this[t[0]]();break;case 1:this[t[0]](t[1][0]);break;case 2:this[t[0]](t[1][0],t[1][1]);break;case 3:this[t[0]](t[1][0],t[1][1],t[1][2]);break;case 4:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3]);break;case 5:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4]);break;case 6:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5])}}},this.redo=function(){if(0!=this.$redoStack.length){this.blurItem();var t=this.$redoStack.pop();if(this.$isUndo=2,"externalFunc"==t[0])t[1][0](t[1][1]);else switch(t[1].length){case 0:this[t[0]]();break;case 1:this[t[0]](t[1][0]);break;case 2:this[t[0]](t[1][0],t[1][1]);break;case 3:this[t[0]](t[1][0],t[1][1],t[1][2]);break;case 4:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3]);break;case 5:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4]);break;case 6:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5])}}}),$(document).keydown({inthis:this},function(t){var e=t.data.inthis;if(""!=e.$focus)switch(t.keyCode){case 46:e.delNode(e.$focus,!0),e.delLine(e.$focus)}}))}GooFlow.prototype={useSVG:"",getSvgMarker:function(t,e){var o=document.createElementNS("http://www.w3.org/2000/svg","marker");o.setAttribute("id",t),o.setAttribute("viewBox","0 0 6 6"),o.setAttribute("refX",5),o.setAttribute("refY",3),o.setAttribute("markerUnits","strokeWidth"),o.setAttribute("markerWidth",6),o.setAttribute("markerHeight",6),o.setAttribute("orient","auto");var i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d","M 0 0 L 6 3 L 0 6 z"),i.setAttribute("fill",e),i.setAttribute("stroke-width",0),o.appendChild(i),o},initDraw:function(t,e,o){if(""!=GooFlow.prototype.useSVG){this.$draw=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.$workArea.prepend(this.$draw);var i=document.createElementNS("http://www.w3.org/2000/svg","defs");this.$draw.appendChild(i),i.appendChild(GooFlow.prototype.getSvgMarker("arrow1",GooFlow.prototype.color.line||"#3892D3")),i.appendChild(GooFlow.prototype.getSvgMarker("arrow2",GooFlow.prototype.color.mark||"#ff3300")),i.appendChild(GooFlow.prototype.getSvgMarker("arrow3",GooFlow.prototype.color.mark||"#ff3300"))}else this.$draw=document.createElement("v:group"),this.$draw.coordsize=3*e+","+3*o,this.$workArea.prepend("<div class='GooFlow_work_vml' style='position:relative;width:"+3*e+"px;height:"+3*o+"px'></div>"),this.$workArea.children("div")[0].insertBefore(this.$draw,null);this.$draw.id=t,this.$draw.style.width=3*e+"px",this.$draw.style.height=3*+o+"px";var a=null;a=""!=GooFlow.prototype.useSVG?"g":"PolyLine",this.$editable&&($(this.$draw).delegate(a,"click",{inthis:this},function(t){t.data.inthis.focusItem(this.id,!0)}),$(this.$draw).delegate(a,"dblclick",{inthis:this},function(t){var e,o,i,a,s,r=t.data.inthis;if(""!=GooFlow.prototype.useSVG)e=this.childNodes[2].textContent,a=this.getAttribute("from").split(","),s=this.getAttribute("to").split(",");else{e=this.childNodes[1].innerHTML;var n=this.getAttribute("fromTo").split(",");a=[n[0],n[1]],s=[n[2],n[3]]}"lr"==r.$lineData[this.id].type?(a[0]=r.$lineData[this.id].M,s[0]=a[0]):"tb"==r.$lineData[this.id].type&&(a[1]=r.$lineData[this.id].M,s[1]=a[1]),o=(parseInt(a[0],10)+parseInt(s[0],10))/2-60,i=(parseInt(a[1],10)+parseInt(s[1],10))/2-12;var l=getElCoordinate(r.$workArea[0]);r.$textArea.val(e).css({display:"block",width:120,height:14,left:l.left+o-r.$workArea[0].parentNode.scrollLeft,top:l.top+i-r.$workArea[0].parentNode.scrollTop}).data("id",r.$focus).focus(),r.$workArea.parent().one("mousedown",function(t){if(2==t.button)return!1;r.setName(r.$textArea.data("id"),r.$textArea.val(),"line"),r.$textArea.val("").removeData("id").hide()})}))},initGroup:function(t,e){this.$group=$("<div class='GooFlow_work_group' style='width:"+3*t+"px;height:"+3*e+"px'></div>"),this.$workArea.prepend(this.$group),this.$editable&&(this.$group.on("mousedown",{inthis:this},function(t){if(2==t.button)return!1;var o=t.data.inthis;if("group"==o.$nowType){if("block"==o.$textArea.css("display"))return o.setName(o.$textArea.data("id"),o.$textArea.val(),"area"),o.$textArea.val("").removeData("id").hide(),!1;t||(t=window.event);var i=$(t.target).css("cursor"),a=t.target.parentNode;switch(i){case"nw-resize":case"w-resize":case"n-resize":a=a.parentNode;break;case"move":break;default:return}a=a.id;var s=1;-1!=navigator.userAgent.indexOf("8.0")&&(s=0);var r,n,e=mousePosition(t),l=getElCoordinate(o.$workArea[0]);if(r=e.x-l.left+o.$workArea[0].parentNode.scrollLeft,n=e.y-l.top+o.$workArea[0].parentNode.scrollTop,"move"!=i){o.$ghost.css({display:"block",width:o.$areaData[a].width-2+"px",height:o.$areaData[a].height-2+"px",top:o.$areaData[a].top+l.top-o.$workArea[0].parentNode.scrollTop+s+"px",left:o.$areaData[a].left+l.left-o.$workArea[0].parentNode.scrollLeft+s+"px",cursor:i});var d=o.$areaData[a].left+o.$areaData[a].width-r,h=o.$areaData[a].top+o.$areaData[a].height-n}else d=r-o.$areaData[a].left,h=n-o.$areaData[a].top;var p=!1;o.$ghost.css("cursor",i),document.onmousemove=function(t){t||(t=window.event);var e=mousePosition(t);if("move"!=i)switch(r=e.x-l.left+o.$workArea[0].parentNode.scrollLeft-o.$areaData[a].left+d,n=e.y-l.top+o.$workArea[0].parentNode.scrollTop-o.$areaData[a].top+h,r<200&&(r=200),n<100&&(n=100),i){case"nw-resize":o.$ghost.css({width:r-2+"px",height:n-2+"px"});break;case"w-resize":o.$ghost.css({width:r-2+"px"});break;case"n-resize":o.$ghost.css({height:n-2+"px"})}else"none"==o.$ghost.css("display")&&o.$ghost.css({display:"block",width:o.$areaData[a].width-2+"px",height:o.$areaData[a].height-2+"px",top:o.$areaData[a].top+l.top-o.$workArea[0].parentNode.scrollTop+s+"px",left:o.$areaData[a].left+l.left-o.$workArea[0].parentNode.scrollLeft+s+"px",cursor:i}),r=e.x-d,n=e.y-h,r<l.left-o.$workArea[0].parentNode.scrollLeft?r=l.left-o.$workArea[0].parentNode.scrollLeft:r+o.$workArea[0].parentNode.scrollLeft+o.$areaData[a].width>l.left+o.$workArea.width()&&(r=l.left+o.$workArea.width()-o.$workArea[0].parentNode.scrollLeft-o.$areaData[a].width),n<l.top-o.$workArea[0].parentNode.scrollTop?n=l.top-o.$workArea[0].parentNode.scrollTop:n+o.$workArea[0].parentNode.scrollTop+o.$areaData[a].height>l.top+o.$workArea.height()&&(n=l.top+o.$workArea.height()-o.$workArea[0].parentNode.scrollTop-o.$areaData[a].height),o.$ghost.css({left:r+s+"px",top:n+s+"px"});p=!0},document.onmouseup=function(t){if(o.$ghost.empty().hide(),document.onmousemove=null,document.onmouseup=null,p)return"move"!=i?o.resizeArea(a,o.$ghost.outerWidth(),o.$ghost.outerHeight()):o.moveArea(a,r+o.$workArea[0].parentNode.scrollLeft-l.left,n+o.$workArea[0].parentNode.scrollTop-l.top),!1}}}),this.$group.on("dblclick",{inthis:this},function(t){var e=t.data.inthis;if("group"==e.$nowType){if(t||(t=window.event),"LABEL"!=t.target.tagName)return!1;var o=t.target.innerHTML,i=t.target.parentNode,a=parseInt(i.style.left,10)+18,s=parseInt(i.style.top,10)+1,r=getElCoordinate(e.$workArea[0]);return e.$textArea.val(o).css({display:"block",width:100,height:14,left:r.left+a-e.$workArea[0].parentNode.scrollLeft,top:r.top+s-e.$workArea[0].parentNode.scrollTop}).data("id",i.id).focus(),e.$workArea.parent().one("mousedown",function(t){if(2==t.button)return!1;"block"==e.$textArea.css("display")&&(e.setName(e.$textArea.data("id"),e.$textArea.val(),"area"),e.$textArea.val("").removeData("id").hide())}),!1}}),this.$group.mouseup({inthis:this},function(t){var e=t.data.inthis;if("group"==e.$nowType){switch(t||(t=window.event),$(t.target).attr("class")){case"rs_close":return e.delArea(t.target.parentNode.parentNode.id),!1;case"bg":return}switch(t.target.tagName){case"LABEL":return!1;case"I":var o=t.target.parentNode.id;switch(e.$areaData[o].color){case"red":e.setAreaColor(o,"yellow");break;case"yellow":e.setAreaColor(o,"blue");break;case"blue":e.setAreaColor(o,"green");break;case"green":e.setAreaColor(o,"red")}return!1}if("none"==t.data.inthis.$ghost.css("display")){var i,a,s=mousePosition(t),r=getElCoordinate(this);i=s.x-r.left+this.parentNode.parentNode.scrollLeft-1,a=s.y-r.top+this.parentNode.parentNode.scrollTop-1;return t.data.inthis.addArea(t.data.inthis.$id+"_area_"+t.data.inthis.$max,{name:"area_"+t.data.inthis.$max,left:i,top:a,color:["red","yellow","blue","green"][t.data.inthis.$max%4],width:200,height:100}),t.data.inthis.$max++,!1}}}))},initLinePointsChg:function(){this.$mpFrom.on("mousedown",{inthis:this},function(t){var e=t.data.inthis;e.switchToolBtn("cursor");var o=e.$mpFrom.data("p").split(","),i=e.$mpTo.data("p").split(",");$(this).hide(),e.$workArea.data("lineEnd",{x:i[0],y:i[1],id:e.$lineData[e.$lineOper.data("tid")].to}).css("cursor","crosshair");var a=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o[0],o[1]],[i[0],i[1]],!0,!0);return e.$draw.appendChild(a),!1}),this.$mpTo.on("mousedown",{inthis:this},function(t){var e=t.data.inthis;e.switchToolBtn("cursor");var o=e.$mpFrom.data("p").split(","),i=e.$mpTo.data("p").split(",");$(this).hide(),e.$workArea.data("lineStart",{x:o[0],y:o[1],id:e.$lineData[e.$lineOper.data("tid")].from}).css("cursor","crosshair");var a=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o[0],o[1]],[i[0],i[1]],!0,!0);return e.$draw.appendChild(a),!1})},setNodeRemarks:function(t){null!=this.$tool&&(this.$tool.children("a").each(function(){this.title=t[$(this).attr("id").split("btn_")[1]]}),this.$nodeRemark=t)},switchToolBtn:function(t){if(this.$tool.children("#"+this.$id+"_btn_"+this.$nowType.split(" ")[0]).attr("class","GooFlow_tool_btn"),"group"==this.$nowType)for(var e in this.$workArea.prepend(this.$group),this.$areaDom)this.$areaDom[e].addClass("lock").children("div:eq(1)").css("display","none");if(this.$nowType=t,this.$tool.children("#"+this.$id+"_btn_"+t.split(" ")[0]).attr("class","GooFlow_tool_btndown"),"group"==this.$nowType)for(var e in this.blurItem(),this.$workArea.append(this.$group),this.$areaDom)this.$areaDom[e].removeClass("lock").children("div:eq(1)").css("display","");else"direct"==this.$nowType&&this.blurItem();"none"==this.$textArea.css("display")&&this.$textArea.removeData("id").val("").hide()},addNode:function(t,e){if(null==this.onItemAdd||this.onItemAdd(t,"node",e)){this.$undoStack&&this.$editable&&this.pushOper("delNode",[t]);var o=e.marked?" item_mark":"";if(e.type.indexOf(" round")<0){(!e.width||e.width<100)&&(e.width=100),(!e.height||e.height<24)&&(e.height=24),(!e.top||e.top<0)&&(e.top=0),(!e.left||e.left<0)&&(e.left=0);-1!=navigator.userAgent.indexOf("8.0")&&2,this.$nodeDom[t]=$("<div class='GooFlow_item"+o+"' id='"+t+"' style='top:"+e.top+"px;left:"+e.left+"px'><table cellspacing='1' style='width:"+(e.width-2)+"px;height:"+(e.height-2)+"px;'><tr><td class='ico'><i class='ico_"+e.type+"'></i></td><td>"+e.name+"</td></tr></table><div style='display:none'><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>")}else e.width=24,e.height=24,this.$nodeDom[t]=$("<div class='GooFlow_item item_round"+o+"' id='"+t+"' style='top:"+e.top+"px;left:"+e.left+"px'><table cellspacing='0'><tr><td class='ico'><i class='ico_"+e.type+"'></i></td></tr></table><div  style='display:none'><div class='rs_close'></div></div><div class='span'>"+e.name+"</div></div>");GooFlow.prototype.color.node&&(-1<e.type.indexOf(" mix")?this.$nodeDom[t].css({"background-color":GooFlow.prototype.color.mix,"border-color":GooFlow.prototype.color.mix}):this.$nodeDom[t].css({"background-color":GooFlow.prototype.color.node,"border-color":GooFlow.prototype.color.node}),o&&GooFlow.prototype.color.mark&&this.$nodeDom[t].css({"border-color":GooFlow.prototype.color.mark})),-1<e.type.indexOf(" mix")&&this.$nodeDom[t].addClass("item_mix");var i=navigator.userAgent.toLowerCase();-1!=i.indexOf("msie")&&-1!=i.indexOf("8.0")&&this.$nodeDom[t].css("filter","progid:DXImageTransform.Microsoft.Shadow(color=#94AAC2,direction=135,strength=2)"),this.$workArea.append(this.$nodeDom[t]),this.$nodeData[t]=e,++this.$nodeCount,this.$editable&&(this.$nodeData[t].alt=!0,this.$deletedItem[t]&&delete this.$deletedItem[t])}},initWorkForNode:function(){this.$workArea.delegate(".GooFlow_item","click",{inthis:this},function(t){t.data.inthis.focusItem(this.id,!0),$(this).removeClass("item_mark")}),this.$workArea.delegate(".ico","mousedown",{inthis:this},function(t){if(t||(t=window.event),2==t.button)return!1;var o=t.data.inthis;if("direct"!=o.$nowType){var e=$(this).parents(".GooFlow_item"),i=e.attr("id");o.focusItem(i,!0);var a=1;-1!=navigator.userAgent.indexOf("8.0")&&(a=0);var s,r,n=mousePosition(t),l=getElCoordinate(o.$workArea[0]);e.children("table").clone().prependTo(o.$ghost),s=n.x-l.left+o.$workArea[0].parentNode.scrollLeft,r=n.y-l.top+o.$workArea[0].parentNode.scrollTop;var d=s-o.$nodeData[i].left,h=r-o.$nodeData[i].top,p=!1;document.onmousemove=function(t){t||(t=window.event);var e=mousePosition(t);if(s==e.x-d&&r==e.y-h)return!1;s=e.x-d,r=e.y-h,p&&"none"==o.$ghost.css("display")&&o.$ghost.css({display:"block",width:o.$nodeData[i].width-2+"px",height:o.$nodeData[i].height-2+"px",top:o.$nodeData[i].top+l.top-o.$workArea[0].parentNode.scrollTop+a+"px",left:o.$nodeData[i].left+l.left-o.$workArea[0].parentNode.scrollLeft+a+"px",cursor:"move"}),s<l.left-o.$workArea[0].parentNode.scrollLeft?s=l.left-o.$workArea[0].parentNode.scrollLeft:s+o.$workArea[0].parentNode.scrollLeft+o.$nodeData[i].width>l.left+o.$workArea.width()&&(s=l.left+o.$workArea.width()-o.$workArea[0].parentNode.scrollLeft-o.$nodeData[i].width),r<l.top-o.$workArea[0].parentNode.scrollTop?r=l.top-o.$workArea[0].parentNode.scrollTop:r+o.$workArea[0].parentNode.scrollTop+o.$nodeData[i].height>l.top+o.$workArea.height()&&(r=l.top+o.$workArea.height()-o.$workArea[0].parentNode.scrollTop-o.$nodeData[i].height),o.$ghost.css({left:s+a+"px",top:r+a+"px"}),p=!0},document.onmouseup=function(t){p&&o.moveNode(i,s+o.$workArea[0].parentNode.scrollLeft-l.left,r+o.$workArea[0].parentNode.scrollTop-l.top),o.$ghost.empty().hide(),document.onmousemove=null,document.onmouseup=null}}}),this.$editable&&(this.$workArea.delegate(".GooFlow_item","mouseenter",{inthis:this},function(t){("direct"==t.data.inthis.$nowType||document.getElementById("GooFlow_tmp_line"))&&$(this).addClass("item_mark").addClass("crosshair").css("border-color",GooFlow.prototype.color.mark||"#ff3300")}),this.$workArea.delegate(".GooFlow_item","mouseleave",{inthis:this},function(t){("direct"==t.data.inthis.$nowType||document.getElementById("GooFlow_tmp_line"))&&($(this).removeClass("item_mark").removeClass("crosshair"),this.id==t.data.inthis.$focus?$(this).css("border-color",GooFlow.prototype.color.line||"#3892D3"):$(this).css("border-color",GooFlow.prototype.color.node||"#A1DCEB"))}),this.$workArea.delegate(".GooFlow_item","mousedown",{inthis:this},function(t){if(2==t.button)return!1;var e=t.data.inthis;if("direct"==e.$nowType){var o,i,a=mousePosition(t),s=getElCoordinate(e.$workArea[0]);o=a.x-s.left+e.$workArea[0].parentNode.scrollLeft,i=a.y-s.top+e.$workArea[0].parentNode.scrollTop,e.$workArea.data("lineStart",{x:o,y:i,id:this.id}).css("cursor","crosshair");var r=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o,i],[o,i],!0,!0);e.$draw.appendChild(r)}}),this.$workArea.delegate(".GooFlow_item","mouseup",{inthis:this},function(t){var e=t.data.inthis;if("direct"==e.$nowType||e.$mpTo.data("p")){var o=e.$workArea.data("lineStart"),i=e.$workArea.data("lineEnd");o&&!e.$mpTo.data("p")?(e.addLine(e.$id+"_line_"+e.$max,{from:o.id,to:this.id,name:""}),e.$max++):(o?e.moveLinePoints(e.$focus,o.id,this.id):i&&e.moveLinePoints(e.$focus,this.id,i.id),e.$nodeData[this.id].marked||($(this).removeClass("item_mark"),this.id!=e.$focus?$(this).css("border-color",GooFlow.prototype.color.node):$(this).css("border-color",GooFlow.prototype.color.line)))}}),this.$workArea.delegate(".GooFlow_item > .span","dblclick",{inthis:this},function(t){var e=this.innerHTML,o=t.data.inthis,i=this.parentNode.id,a=getElCoordinate(o.$workArea[0]);o.$textArea.val(e).css({display:"block",height:$(this).height(),width:100,left:a.left+o.$nodeData[i].left-o.$workArea[0].parentNode.scrollLeft-24,top:a.top+o.$nodeData[i].top-o.$workArea[0].parentNode.scrollTop+26}).data("id",o.$focus).focus(),o.$workArea.parent().one("mousedown",function(t){if(2==t.button)return!1;o.setName(o.$textArea.data("id"),o.$textArea.val(),"node"),o.$textArea.val("").removeData("id").hide()})}),this.$workArea.delegate(".ico + td","dblclick",{inthis:this},function(t){var e=this.innerHTML,o=t.data.inthis,i=$(this).parents(".GooFlow_item").attr("id"),a=getElCoordinate(o.$workArea[0]);o.$textArea.val(e).css({display:"block",width:$(this).width()+24,height:$(this).height(),left:a.left+24+o.$nodeData[i].left-o.$workArea[0].parentNode.scrollLeft,top:a.top+2+o.$nodeData[i].top-o.$workArea[0].parentNode.scrollTop}).data("id",o.$focus).focus(),o.$workArea.parent().one("mousedown",function(t){if(2==t.button)return!1;o.setName(o.$textArea.data("id"),o.$textArea.val(),"node"),o.$textArea.val("").removeData("id").hide()})}),this.$workArea.delegate(".rs_close","click",{inthis:this},function(t){return t||(t=window.event),t.data.inthis.delNode(t.data.inthis.$focus),!1}),this.$workArea.delegate(".GooFlow_item > div > div[class!=rs_close]","mousedown",{inthis:this},function(t){if(t||(t=window.event),2==t.button)return!1;var o=$(this).css("cursor");if("pointer"!=o){var i=t.data.inthis,a=i.$focus;i.switchToolBtn("cursor"),t.cancelBubble=!0,t.stopPropagation();var e=1;-1!=navigator.userAgent.indexOf("8.0")&&(e=0);var s,r,n=mousePosition(t),l=getElCoordinate(i.$workArea[0]);i.$ghost.css({display:"block",width:i.$nodeData[a].width-2+"px",height:i.$nodeData[a].height-2+"px",top:i.$nodeData[a].top+l.top-i.$workArea[0].parentNode.scrollTop+e+"px",left:i.$nodeData[a].left+l.left-i.$workArea[0].parentNode.scrollLeft+e+"px",cursor:o}),s=n.x-l.left+i.$workArea[0].parentNode.scrollLeft,r=n.y-l.top+i.$workArea[0].parentNode.scrollTop;var d=i.$nodeData[a].left+i.$nodeData[a].width-s,h=i.$nodeData[a].top+i.$nodeData[a].height-r,p=!1;i.$ghost.css("cursor",o),document.onmousemove=function(t){t||(t=window.event);var e=mousePosition(t);switch(s=e.x-l.left+i.$workArea[0].parentNode.scrollLeft-i.$nodeData[a].left+d,r=e.y-l.top+i.$workArea[0].parentNode.scrollTop-i.$nodeData[a].top+h,s<100&&(s=100),r<24&&(r=24),p=!0,o){case"nw-resize":i.$ghost.css({width:s-2+"px",height:r-2+"px"});break;case"w-resize":i.$ghost.css({width:s-2+"px"});break;case"n-resize":i.$ghost.css({height:r-2+"px"})}},document.onmouseup=function(t){i.$ghost.hide(),p&&(t||(t=window.event),i.resizeNode(a,i.$ghost.outerWidth(),i.$ghost.outerHeight()),document.onmousemove=null,document.onmouseup=null)}}}))},getItemInfo:function(t,e){switch(e){case"node":return this.$nodeData[t]||null;case"line":return this.$lineData[t]||null;case"area":return this.$areaData[t]||null}},blurItem:function(){if(""!=this.$focus){var t=$("#"+this.$focus);if("DIV"==t.prop("tagName")){if(null!=this.onItemBlur&&!this.onItemBlur(this.$focus,"node"))return!1;t.removeClass("item_focus").children("div:eq(0)").css("display","none"),GooFlow.prototype.color.line&&(this.$nodeData[this.$focus].marked?t.css("border-color",GooFlow.prototype.color.mark||"#ff3300"):t.css("border-color",GooFlow.prototype.color.node||"#A1DCEB"))}else{if(null!=this.onItemBlur&&!this.onItemBlur(this.$focus,"line"))return!1;""!=GooFlow.prototype.useSVG?this.$lineData[this.$focus].marked||(t[0].childNodes[1].setAttribute("stroke",GooFlow.prototype.color.line||"#3892D3"),t[0].childNodes[1].setAttribute("marker-end","url(#arrow1)")):this.$lineData[this.$focus].marked||(t[0].strokeColor=GooFlow.prototype.color.line||"#3892D3"),this.$lineMove.hide().removeData("type").removeData("tid"),this.$editable&&(this.$lineOper.hide().removeData("tid"),this.$mpFrom.hide().removeData("p"),this.$mpTo.hide().removeData("p"))}}return!(this.$focus="")},focusItem:function(t,e){var o=$("#"+t);if(0!=o.length&&this.blurItem()){if("DIV"==o.prop("tagName")){if(e&&null!=this.onItemFocus&&!this.onItemFocus(t,"node"))return;o.addClass("item_focus"),GooFlow.prototype.color.line&&o.css("border-color",GooFlow.prototype.color.line),this.$editable&&o.children("div:eq(0)").css("display","block"),this.$workArea.append(o)}else{if(null!=this.onItemFocus&&!this.onItemFocus(t,"line"))return;if(""!=GooFlow.prototype.useSVG?(o[0].childNodes[1].setAttribute("stroke",GooFlow.prototype.color.mark||"#ff3300"),o[0].childNodes[1].setAttribute("marker-end","url(#arrow2)")):o[0].strokeColor=GooFlow.prototype.color.mark||"#ff3300",!this.$editable)return;var i,a,s,r,n;""!=GooFlow.prototype.useSVG?(s=o.attr("from").split(","),r=o.attr("to").split(","),n=[s[0],s[1],r[0],r[1]]):(s=[(n=o[0].getAttribute("fromTo").split(","))[0],n[1]],r=[n[2],n[3]]),s[0]=parseInt(s[0],10),s[1]=parseInt(s[1],10),r[0]=parseInt(r[0],10),r[1]=parseInt(r[1],10),"lr"==this.$lineData[t].type?(s[0]=this.$lineData[t].M,r[0]=s[0],this.$lineMove.css({width:"5px",height:(r[1]-s[1])*(r[1]>s[1]?1:-1)+"px",left:s[0]-3+"px",top:(r[1]>s[1]?s[1]:r[1])+1+"px",cursor:"e-resize",display:"block"}).data({type:"lr",tid:t})):"tb"==this.$lineData[t].type&&(s[1]=this.$lineData[t].M,r[1]=s[1],this.$lineMove.css({width:(r[0]-s[0])*(r[0]>s[0]?1:-1)+"px",height:"5px",left:(r[0]>s[0]?s[0]:r[0])+1+"px",top:s[1]-3+"px",cursor:"s-resize",display:"block"}).data({type:"tb",tid:t})),i=(s[0]+r[0])/2-35,a=(s[1]+r[1])/2+6,this.$lineOper.css({display:"block",left:i+"px",top:a+"px"}).data("tid",t),this.$editable&&(this.$mpFrom.css({display:"block",left:n[0]-4+"px",top:n[1]-4+"px"}).data("p",n[0]+","+n[1]),this.$mpTo.css({display:"block",left:n[2]-4+"px",top:n[3]-4+"px"}).data("p",n[2]+","+n[3])),this.$draw.appendChild(o[0])}this.$focus=t,this.switchToolBtn("cursor")}},moveNode:function(t,e,o){if(this.$nodeData[t]&&(null==this.onItemMove||this.onItemMove(t,"node",e,o))){if(this.$undoStack){var i=[t,this.$nodeData[t].left,this.$nodeData[t].top];this.pushOper("moveNode",i)}e<0&&(e=0),o<0&&(o=0),$("#"+t).css({left:e+"px",top:o+"px"}),this.$nodeData[t].left=e,this.$nodeData[t].top=o,this.resetLines(t,this.$nodeData[t]),this.$editable&&(this.$nodeData[t].alt=!0)}},setName:function(t,e,o){var i;if("node"==o){if(!this.$nodeData[t])return;if(this.$nodeData[t].name==e)return;if(null!=this.onItemRename&&!this.onItemRename(t,e,"node"))return;if(i=this.$nodeData[t].name,this.$nodeData[t].name=e,1<this.$nodeData[t].type.indexOf("round"))this.$nodeDom[t].children(".span").text(e);else{this.$nodeDom[t].find("td:eq(1)").text(e);-1!=navigator.userAgent.indexOf("8.0")&&2;var a=this.$nodeDom[t].outerWidth(),s=this.$nodeDom[t].outerHeight();this.$nodeDom[t].children("table").css({width:a-2+"px",height:s-2+"px"}),this.$nodeData[t].width=a,this.$nodeData[t].height=s}this.$editable&&(this.$nodeData[t].alt=!0),this.resetLines(t,this.$nodeData[t])}else if("line"==o){if(!this.$lineData[t])return;if(this.$lineData[t].name==e)return;if(null!=this.onItemRename&&!this.onItemRename(t,e,"line"))return;if(i=this.$lineData[t].name,this.$lineData[t].name=e,""!=GooFlow.prototype.useSVG)this.$lineDom[t].childNodes[2].textContent=e;else{this.$lineDom[t].childNodes[1].innerHTML=e;var r,n=this.$lineDom[t].getAttribute("fromTo").split(",");if("lr"!=this.$lineData[t].type)r=(n[2]-n[0])/2;else{var l=n[2]>n[0]?n[0]:n[2];l>this.$lineData[t].M&&(l=this.$lineData[t].M),r=this.$lineData[t].M-l}r<0&&(r*=-1),this.$lineDom[t].childNodes[1].style.left=r-this.$lineDom[t].childNodes[1].offsetWidth/2+4+"px"}this.$editable&&(this.$lineData[t].alt=!0)}else if("area"==o){if(!this.$areaData[t])return;if(this.$areaData[t].name==e)return;if(null!=this.onItemRename&&!this.onItemRename(t,e,"area"))return;i=this.$areaData[t].name,this.$areaData[t].name=e,this.$areaDom[t].children("label").text(e),this.$editable&&(this.$areaData[t].alt=!0)}if(this.$undoStack){var d=[t,i,o];this.pushOper("setName",d)}},resizeNode:function(t,e,o){if(this.$nodeData[t]&&(null==this.onItemResize||this.onItemResize(t,"node",e,o))&&"start"!=this.$nodeData[t].type&&"end"!=this.$nodeData[t].type){if(this.$undoStack){var i=[t,this.$nodeData[t].width,this.$nodeData[t].height];this.pushOper("resizeNode",i)}var a=0;-1!=navigator.userAgent.indexOf("8.0")&&(a=2),this.$nodeDom[t].children("table").css({width:e-2+"px",height:o-2+"px"}),e=this.$nodeDom[t].outerWidth()-a,o=this.$nodeDom[t].outerHeight()-a,this.$nodeDom[t].children("table").css({width:e-2+"px",height:o-2+"px"}),this.$nodeData[t].width=e,this.$nodeData[t].height=o,this.$editable&&(this.$nodeData[t].alt=!0),this.resetLines(t,this.$nodeData[t])}},delNode:function(t){if(this.$nodeData[t]&&(null==this.onItemDel||this.onItemDel(t,"node"))){for(var e in this.$lineData)this.$lineData[e].from!=t&&this.$lineData[e].to!=t||this.delLine(e);if(this.$undoStack){var o=[t,this.$nodeData[t]];this.pushOper("addNode",o)}delete this.$nodeData[t],this.$nodeDom[t].remove(),delete this.$nodeDom[t],--this.$nodeCount,this.$focus==t&&(this.$focus=""),this.$editable&&t.indexOf(this.$id+"_node_")<0&&(this.$deletedItem[t]="node")}},setTitle:function(t){this.$title=t,this.$head&&this.$head.children("label").attr("title",t).text(t)},loadData:function(t){var e=this.$editable;for(var o in this.$editable=!1,t.title&&this.setTitle(t.title),t.initNum&&(this.$max=t.initNum),t.nodes)this.addNode(o,t.nodes[o]);for(var i in t.lines)this.addLine(i,t.lines[i]);for(var a in t.areas)this.addArea(a,t.areas[a]);this.$editable=e,this.$deletedItem={}},loadDataAjax:function(i){var e=this;$.ajax({type:i.type,url:i.url,dataType:"json",data:i.data,success:function(t){i.dataFilter&&i.dataFilter(t,"json"),e.loadData(t),i.success&&i.success(t)},error:function(t,e,o){i.error&&i.error(e,o)}})},exportData:function(){var t={title:this.$title,nodes:this.$nodeData,lines:this.$lineData,areas:this.$areaData,initNum:this.$max};for(var e in t.nodes)t.nodes[e].marked||delete t.nodes[e].marked;for(var o in t.lines)t.lines[o].marked||delete t.lines[o].marked;return t},exportAlter:function(){var t={nodes:{},lines:{},areas:{}};for(var e in this.$nodeData)this.$nodeData[e].alt&&(t.nodes[e]=this.$nodeData[e]);for(var o in this.$lineData)this.$lineData[o].alt&&(t.lines[o]=this.$lineData[o]);for(var i in this.$areaData)this.$areaData[i].alt&&(t.areas[i]=this.$areaData[i]);return t.deletedItem=this.$deletedItem,t},transNewId:function(t,e,o){var i;switch(o){case"node":this.$nodeData[t]&&(i=this.$nodeData[t],delete this.$nodeData[t],this.$nodeData[e]=i,i=this.$nodeDom[t].attr("id",e),delete this.$nodeDom[t],this.$nodeDom[e]=i);break;case"line":this.$lineData[t]&&(i=this.$lineData[t],delete this.$lineData[t],this.$lineData[e]=i,i=this.$lineDom[t].attr("id",e),delete this.$lineDom[t],this.$lineDom[e]=i);break;case"area":this.$areaData[t]&&(i=this.$areaData[t],delete this.$areaData[t],this.$areaData[e]=i,i=this.$areaDom[t].attr("id",e),delete this.$areaDom[t],this.$areaDom[e]=i)}},clearData:function(){for(var t in this.$nodeData)this.delNode(t);for(var t in this.$lineData)this.delLine(t);for(var t in this.$areaData)this.delArea(t);this.$deletedItem={}},destrory:function(){this.$bgDiv.empty(),this.$lineData=null,this.$nodeData=null,this.$lineDom=null,this.$nodeDom=null,this.$areaDom=null,this.$areaData=null,this.$nodeCount=0,this.$areaCount=0,this.$areaCount=0,this.$deletedItem={}},drawLine:function(t,e,o,i,a){var s;if(""!=GooFlow.prototype.useSVG){s=document.createElementNS("http://www.w3.org/2000/svg","g");var r=document.createElementNS("http://www.w3.org/2000/svg","path"),n=document.createElementNS("http://www.w3.org/2000/svg","path");if(""!=t&&s.setAttribute("id",t),s.setAttribute("from",e[0]+","+e[1]),s.setAttribute("to",o[0]+","+o[1]),r.setAttribute("visibility","hidden"),r.setAttribute("stroke-width",9),r.setAttribute("fill","none"),r.setAttribute("stroke","white"),r.setAttribute("d","M "+e[0]+" "+e[1]+" L "+o[0]+" "+o[1]),r.setAttribute("pointer-events","stroke"),n.setAttribute("d","M "+e[0]+" "+e[1]+" L "+o[0]+" "+o[1]),n.setAttribute("stroke-width",1.4),n.setAttribute("stroke-linecap","round"),n.setAttribute("fill","none"),a&&n.setAttribute("style","stroke-dasharray:6,5"),i?(n.setAttribute("stroke",GooFlow.prototype.color.mark||"#ff3300"),n.setAttribute("marker-end","url(#arrow2)")):(n.setAttribute("stroke",GooFlow.prototype.color.line||"#3892D3"),n.setAttribute("marker-end","url(#arrow1)")),s.appendChild(r),s.appendChild(n),s.style.cursor="crosshair",""!=t&&"GooFlow_tmp_line"!=t){(h=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("fill",GooFlow.prototype.color.font||"#333"),s.appendChild(h);var l=(o[0]+e[0])/2,d=(o[1]+e[1])/2;h.setAttribute("text-anchor","middle"),h.setAttribute("x",l),h.setAttribute("y",d),s.style.cursor="pointer",h.style.cursor="text"}}else{if(s=document.createElement("v:polyline"),""!=t&&(s.id=t),s.points.value=e[0]+","+e[1]+" "+o[0]+","+o[1],s.setAttribute("fromTo",e[0]+","+e[1]+","+o[0]+","+o[1]),s.strokeWeight="1.2",s.stroke.EndArrow="Block",s.style.cursor="crosshair",""!=t&&"GooFlow_tmp_line"!=t){var h=document.createElement("div");s.appendChild(h),(l=(o[0]-e[0])/2)<0&&(l*=-1),(d=(o[1]-e[1])/2)<0&&(d*=-1),h.style.left=l+"px",h.style.top=d-6+"px",s.style.cursor="pointer"}a&&(s.stroke.dashstyle="Dash"),s.strokeColor=i?GooFlow.prototype.color.mark||"#ff3300":GooFlow.prototype.color.line||"#3892D3",s.fillColor=GooFlow.prototype.color.line||"#3892D3"}return s},drawPoly:function(t,e,o,i,a,s){var r,n;if(""!=GooFlow.prototype.useSVG){r=document.createElementNS("http://www.w3.org/2000/svg","g");var l=document.createElementNS("http://www.w3.org/2000/svg","path"),d=document.createElementNS("http://www.w3.org/2000/svg","path");""!=t&&r.setAttribute("id",t),r.setAttribute("from",e[0]+","+e[1]),r.setAttribute("to",a[0]+","+a[1]),l.setAttribute("visibility","hidden"),l.setAttribute("stroke-width",9),l.setAttribute("fill","none"),l.setAttribute("stroke","white"),n="M "+e[0]+" "+e[1],o[0]==e[0]&&o[1]==e[1]||(n+=" L "+o[0]+" "+o[1]),i[0]==a[0]&&i[1]==a[1]||(n+=" L "+i[0]+" "+i[1]),n+=" L "+a[0]+" "+a[1],l.setAttribute("d",n),l.setAttribute("pointer-events","stroke"),d.setAttribute("d",n),d.setAttribute("stroke-width",1.4),d.setAttribute("stroke-linecap","round"),d.setAttribute("fill","none"),s?(d.setAttribute("stroke",GooFlow.prototype.color.mark||"#ff3300"),d.setAttribute("marker-end","url(#arrow2)")):(d.setAttribute("stroke",GooFlow.prototype.color.line||"#3892D3"),d.setAttribute("marker-end","url(#arrow1)")),r.appendChild(l),r.appendChild(d),($=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("fill",GooFlow.prototype.color.font||"#333"),r.appendChild($);var h=(i[0]+o[0])/2,p=(i[1]+o[1])/2;$.setAttribute("text-anchor","middle"),$.setAttribute("x",h),$.setAttribute("y",p),$.style.cursor="text",r.style.cursor="pointer"}else{r=document.createElement("v:Polyline"),""!=t&&(r.id=t),r.filled="false",n=e[0]+","+e[1],o[0]==e[0]&&o[1]==e[1]||(n+=" "+o[0]+","+o[1]),i[0]==a[0]&&i[1]==a[1]||(n+=" "+i[0]+","+i[1]),n+=" "+a[0]+","+a[1],r.points.value=n,r.setAttribute("fromTo",e[0]+","+e[1]+","+a[0]+","+a[1]),r.strokeWeight="1.2",r.stroke.EndArrow="Block";var $=document.createElement("div");r.appendChild($),(h=(i[0]-o[0])/2)<0&&(h*=-1),(p=(i[1]-o[1])/2)<0&&(p*=-1),$.style.left=h+"px",$.style.top=p-4+"px",r.style.cursor="pointer",r.strokeColor=s?GooFlow.prototype.color.mark||"#ff3300":GooFlow.prototype.color.line||"#3892D3"}return r},calcStartEnd:function(t,e){var o,i,a,s,r=t.left,n=t.left+t.width,l=e.left,d=e.left+e.width;d<=r?(o=r,a=d):n<=l?(o=n,a=l):r<=l&&l<=n&&n<=d?a=o=(n+l)/2:l<=r&&n<=d?a=o=(r+n)/2:r<=l&&d<=n?a=o=(l+d)/2:r<=d&&d<=n&&(a=o=(r+d)/2);var h=t.top,p=t.top+t.height,$=e.top,c=e.top+e.height;return c<=h?(i=h,s=c):p<=$?(i=p,s=$):h<=$&&$<=p&&p<=c?s=i=(p+$)/2:$<=h&&p<=c?s=i=(h+p)/2:h<=$&&c<=p?s=i=($+c)/2:h<=c&&c<=p&&(s=i=(h+c)/2),{start:[o,i],end:[a,s]}},calcPolyPoints:function(t,e,o,i){var a={x:t.left+t.width/2,y:t.top+t.height/2},s={x:e.left+e.width/2,y:e.top+e.height/2},r=[],n=[],l=[],d=[];return r=[a.x,a.y],d=[s.x,s.y],"lr"==o?(l=[i,s.y],(n=[i,a.y])[0]>t.left&&n[0]<t.left+t.width?(n[1]=s.y<a.y?t.top:t.top+t.height,r[0]=n[0],r[1]=n[1]):r[0]=n[0]<t.left?t.left:t.left+t.width,l[0]>e.left&&l[0]<e.left+e.width?(l[1]=s.y<a.y?e.top+e.height:e.top,d[0]=l[0],d[1]=l[1]):d[0]=l[0]<e.left?e.left:e.left+e.width):"tb"==o&&(l=[s.x,i],(n=[a.x,i])[1]>t.top&&n[1]<t.top+t.height?(n[0]=s.x<a.x?t.left:t.left+t.width,r[0]=n[0],r[1]=n[1]):r[1]=n[1]<t.top?t.top:t.top+t.height,l[1]>e.top&&l[1]<e.top+e.height?(l[0]=s.x<a.x?e.left+e.width:e.left,d[0]=l[0],d[1]=l[1]):d[1]=l[1]<e.top?e.top:e.top+e.height),{start:r,m1:n,m2:l,end:d}},getMValue:function(t,e,o){return"lr"==o?(t.left+t.width/2+e.left+e.width/2)/2:"tb"==o?(t.top+t.height/2+e.top+e.height/2)/2:void 0},addLineDom:function(t,e){var o,i=this.$nodeData[e.from],a=this.$nodeData[e.to];if(i&&a&&(o=e.type&&"sl"!=e.type?GooFlow.prototype.calcPolyPoints(i,a,e.type,e.M):GooFlow.prototype.calcStartEnd(i,a)))if("sl"==e.type?this.$lineDom[t]=GooFlow.prototype.drawLine(t,o.start,o.end,e.marked):this.$lineDom[t]=GooFlow.prototype.drawPoly(t,o.start,o.m1,o.m2,o.end,e.marked),this.$draw.appendChild(this.$lineDom[t]),""==GooFlow.prototype.useSVG)if(this.$lineDom[t].childNodes[1].innerHTML=e.name,"sl"!=e.type){var s=o.start[0]>o.end[0]?o.end[0]:o.start[0];s>o.m2[0]&&(s=o.m2[0]),s>o.m1[0]&&(s=o.m1[0]),this.$lineDom[t].childNodes[1].style.left=(o.m2[0]+o.m1[0])/2-s-this.$lineDom[t].childNodes[1].offsetWidth/2+4,(s=o.start[1]>o.end[1]?o.end[1]:o.start[1])>o.m2[1]&&(s=o.m2[1]),s>o.m1[1]&&(s=o.m1[1]),this.$lineDom[t].childNodes[1].style.top=(o.m2[1]+o.m1[1])/2-s-this.$lineDom[t].childNodes[1].offsetHeight/2}else this.$lineDom[t].childNodes[1].style.left=((o.end[0]-o.start[0])*(o.end[0]>o.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4;else this.$lineDom[t].childNodes[2].textContent=e.name},addLine:function(t,e){if((null==this.onItemAdd||this.onItemAdd(t,"line",e))&&(this.$undoStack&&this.$editable&&this.pushOper("delLine",[t]),e.from!=e.to)){var o=this.$nodeData[e.from],i=this.$nodeData[e.to];if(o&&i){for(var a in this.$lineData)if(e.from==this.$lineData[a].from&&e.to==this.$lineData[a].to)return;this.$lineData[t]={},e.type?(this.$lineData[t].type=e.type,this.$lineData[t].M=e.M):this.$lineData[t].type="sl",this.$lineData[t].from=e.from,this.$lineData[t].to=e.to,this.$lineData[t].name=e.name,e.marked?this.$lineData[t].marked=e.marked:this.$lineData[t].marked=!1,this.addLineDom(t,this.$lineData[t]),++this.$lineCount,this.$editable&&(this.$lineData[t].alt=!0,this.$deletedItem[t]&&delete this.$deletedItem[t])}}},resetLines:function(t,e){for(var o in this.$lineData){var i,a=null;if(this.$lineData[o].from==t){if(null==(a=this.$nodeData[this.$lineData[o].to]||null))continue;if(!(i="sl"==this.$lineData[o].type?GooFlow.prototype.calcStartEnd(e,a):GooFlow.prototype.calcPolyPoints(e,a,this.$lineData[o].type,this.$lineData[o].M)))break}else if(this.$lineData[o].to==t){if(null==(a=this.$nodeData[this.$lineData[o].from]||null))continue;if(!(i="sl"==this.$lineData[o].type?GooFlow.prototype.calcStartEnd(a,e):GooFlow.prototype.calcPolyPoints(a,e,this.$lineData[o].type,this.$lineData[o].M)))break}if(null!=a)if(this.$draw.removeChild(this.$lineDom[o]),"sl"==this.$lineData[o].type?this.$lineDom[o]=GooFlow.prototype.drawLine(o,i.start,i.end,this.$lineData[o].marked):this.$lineDom[o]=GooFlow.prototype.drawPoly(o,i.start,i.m1,i.m2,i.end,this.$lineData[o].marked),this.$draw.appendChild(this.$lineDom[o]),""==GooFlow.prototype.useSVG)if(this.$lineDom[o].childNodes[1].innerHTML=this.$lineData[o].name,"sl"!=this.$lineData[o].type){var s=i.start[0]>i.end[0]?i.end[0]:i.start[0];s>i.m2[0]&&(s=i.m2[0]),s>i.m1[0]&&(s=i.m1[0]),this.$lineDom[o].childNodes[1].style.left=(i.m2[0]+i.m1[0])/2-s-this.$lineDom[o].childNodes[1].offsetWidth/2+4,(s=i.start[1]>i.end[1]?i.end[1]:i.start[1])>i.m2[1]&&(s=i.m2[1]),s>i.m1[1]&&(s=i.m1[1]),this.$lineDom[o].childNodes[1].style.top=(i.m2[1]+i.m1[1])/2-s-this.$lineDom[o].childNodes[1].offsetHeight/2-4}else this.$lineDom[o].childNodes[1].style.left=((i.end[0]-i.start[0])*(i.end[0]>i.start[0]?1:-1)-this.$lineDom[o].childNodes[1].offsetWidth)/2+4;else this.$lineDom[o].childNodes[2].textContent=this.$lineData[o].name}},setLineType:function(t,e,o){if(!e||null==e||""==e||e==this.$lineData[t].type)return!1;if(null==this.onLineSetType||this.onLineSetType(t,e)){if(this.$undoStack){var i=[t,this.$lineData[t].type,this.$lineData[t].M];this.pushOper("setLineType",i)}var a=this.$lineData[t].from,s=this.$lineData[t].to;if("sl"!=(this.$lineData[t].type=e)){var r=GooFlow.prototype.calcPolyPoints(this.$nodeData[a],this.$nodeData[s],this.$lineData[t].type,this.$lineData[t].M);o?this.setLineM(t,o,!0):this.setLineM(t,this.getMValue(this.$nodeData[a],this.$nodeData[s],e),!0)}else{if(delete this.$lineData[t].M,this.$lineMove.hide().removeData("type").removeData("tid"),!(r=GooFlow.prototype.calcStartEnd(this.$nodeData[a],this.$nodeData[s])))return;this.$draw.removeChild(this.$lineDom[t]),this.$lineDom[t]=GooFlow.prototype.drawLine(t,r.start,r.end,this.$lineData[t].marked||this.$focus==t),this.$draw.appendChild(this.$lineDom[t]),""==GooFlow.prototype.useSVG?(this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name,this.$lineDom[t].childNodes[1].style.left=((r.end[0]-r.start[0])*(r.end[0]>r.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4):this.$lineDom[t].childNodes[2].textContent=this.$lineData[t].name}this.$focus==t&&this.focusItem(t),this.$editable&&(this.$lineData[t].alt=!0)}},setLineM:function(t,e,o){if(!this.$lineData[t]||e<0||!this.$lineData[t].type||"sl"==this.$lineData[t].type)return!1;if(null!=this.onLineMove&&!this.onLineMove(t,e))return!1;if(this.$undoStack&&!o){var i=[t,this.$lineData[t].M];this.pushOper("setLineM",i)}var a=this.$lineData[t].from,s=this.$lineData[t].to;this.$lineData[t].M=e;var r=GooFlow.prototype.calcPolyPoints(this.$nodeData[a],this.$nodeData[s],this.$lineData[t].type,this.$lineData[t].M);if(this.$draw.removeChild(this.$lineDom[t]),this.$lineDom[t]=GooFlow.prototype.drawPoly(t,r.start,r.m1,r.m2,r.end,this.$lineData[t].marked||this.$focus==t),this.$draw.appendChild(this.$lineDom[t]),""==GooFlow.prototype.useSVG){this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name;var n=r.start[0]>r.end[0]?r.end[0]:r.start[0];n>r.m2[0]&&(n=r.m2[0]),n>r.m1[0]&&(n=r.m1[0]),this.$lineDom[t].childNodes[1].style.left=(r.m2[0]+r.m1[0])/2-n-this.$lineDom[t].childNodes[1].offsetWidth/2+4,(n=r.start[1]>r.end[1]?r.end[1]:r.start[1])>r.m2[1]&&(n=r.m2[1]),n>r.m1[1]&&(n=r.m1[1]),this.$lineDom[t].childNodes[1].style.top=(r.m2[1]+r.m1[1])/2-n-this.$lineDom[t].childNodes[1].offsetHeight/2-4}else this.$lineDom[t].childNodes[2].textContent=this.$lineData[t].name;this.$editable&&(this.$lineData[t].alt=!0)},delLine:function(t){if(this.$lineData[t]&&(null==this.onItemDel||this.onItemDel(t,"node"))){if(this.$undoStack){var e=[t,this.$lineData[t]];this.pushOper("addLine",e)}this.$draw.removeChild(this.$lineDom[t]),delete this.$lineData[t],delete this.$lineDom[t],this.$focus==t&&(this.$focus=""),--this.$lineCount,this.$editable&&(t.indexOf(this.$id+"_line_")<0&&(this.$deletedItem[t]="line"),this.$mpFrom.hide().removeData("p"),this.$mpTo.hide().removeData("p")),this.$lineOper.hide().removeData("tid")}},moveLinePoints:function(t,e,o,i){if(e!=o&&t&&this.$lineData[t]){for(var a in null!=e&&""!=e||(e=this.$lineData[t].from),null!=o&&""!=o||(o=this.$lineData[t].to),this.$lineData)if(e==this.$lineData[a].from&&o==this.$lineData[a].to)return;if(null==this.onLinePointMove||this.onLinePointMove(id,e,o)){if(this.$undoStack&&!i){var s=[t,this.$lineData[t].from,this.$lineData[t].to];this.pushOper("moveLinePoints",s)}null!=e&&""!=e&&(this.$lineData[t].from=e),null!=o&&""!=o&&(this.$lineData[t].to=o),this.$draw.removeChild(this.$lineDom[t]),this.addLineDom(t,this.$lineData[t]),this.$editable&&(this.$lineData[t].alt=!0)}}},markItem:function(t,e,o){if("node"==e){if(!this.$nodeData[t])return;if(null!=this.onItemMark&&!this.onItemMark(t,"node",o))return;this.$nodeData[t].marked=o||!1,o?(this.$nodeDom[t].addClass("item_mark"),jq.css("border-color",GooFlow.prototype.color.mark)):(this.$nodeDom[t].removeClass("item_mark"),t!=this.$focus&&jq.css("border-color","transparent"))}else if("line"==e){if(!this.$lineData[t])return;if(null!=this.onItemMark&&!this.onItemMark(t,"line",o))return;this.$lineData[t].marked=o||!1,""!=GooFlow.prototype.useSVG?o?(this.$nodeDom[t].childNodes[1].setAttribute("stroke",GooFlow.prototype.color.mark||"#ff3300"),this.$nodeDom[t].childNodes[1].setAttribute("marker-end","url(#arrow2)")):(this.$nodeDom[t].childNodes[1].setAttribute("stroke",GooFlow.prototype.color.line||"#3892D3"),this.$nodeDom[t].childNodes[1].setAttribute("marker-end","url(#arrow1)")):this.$nodeDom[t].strokeColor=o?GooFlow.prototype.color.mark||"#ff3300":GooFlow.prototype.color.line||"#3892D3"}if(this.$undoStatck){var i=[t,e,!o];this.pushOper("markItem",i)}},moveArea:function(t,e,o){if(this.$areaData[t]&&(null==this.onItemMove||this.onItemMove(t,"area",e,o))){if(this.$undoStack){var i=[t,this.$areaData[t].left,this.$areaData[t].top];this.pushOper("moveNode",i)}e<0&&(e=0),o<0&&(o=0),$("#"+t).css({left:e+"px",top:o+"px"}),this.$areaData[t].left=e,this.$areaData[t].top=o,this.$editable&&(this.$areaData[t].alt=!0)}},delArea:function(t){if(this.$areaData[t]){if(this.$undoStack){var e=[t,this.$areaData[t]];this.pushOper("addArea",e)}(null==this.onItemDel||this.onItemDel(t,"node"))&&(delete this.$areaData[t],this.$areaDom[t].remove(),delete this.$areaDom[t],--this.$areaCount,this.$editable&&t.indexOf(this.$id+"_area_")<0&&(this.$deletedItem[t]="area"))}},setAreaColor:function(t,e){if(this.$areaData[t]){if(this.$undoStack){var o=[t,this.$areaData[t].color];this.pushOper("setAreaColor",o)}"red"!=e&&"yellow"!=e&&"blue"!=e&&"green"!=e||(this.$areaDom[t].removeClass("area_"+this.$areaData[t].color).addClass("area_"+e),this.$areaData[t].color=e),this.$editable&&(this.$areaData[t].alt=!0)}},resizeArea:function(t,e,o){if(this.$areaData[t]&&(null==this.onItemResize||this.onItemResize(t,"area",e,o))){if(this.$undoStack){var i=[t,this.$areaData[t].width,this.$areaData[t].height];this.pushOper("resizeArea",i)}-1!=navigator.userAgent.indexOf("8.0")&&2,this.$areaDom[t].children(".bg").css({width:e-2+"px",height:o-2+"px"}),e=this.$areaDom[t].outerWidth(),o=this.$areaDom[t].outerHeight(),this.$areaDom[t].children("bg").css({width:e-2+"px",height:o-2+"px"}),this.$areaData[t].width=e,this.$areaData[t].height=o,this.$editable&&(this.$areaData[t].alt=!0)}},addArea:function(t,e){(null==this.onItemAdd||this.onItemAdd(t,"area",e))&&(this.$undoStack&&this.$editable&&this.pushOper("delArea",[t]),this.$areaDom[t]=$("<div id='"+t+"' class='GooFlow_area area_"+e.color+"' style='top:"+e.top+"px;left:"+e.left+"px'><div class='bg' style='width:"+(e.width-2)+"px;height:"+(e.height-2)+"px'></div><label>"+e.name+"</label><i></i><div><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>"),this.$areaData[t]=e,this.$group.append(this.$areaDom[t]),"group"!=this.$nowType&&this.$areaDom[t].children("div:eq(1)").css("display","none"),++this.$areaCount,this.$editable&&(this.$areaData[t].alt=!0,this.$deletedItem[t]&&delete this.$deletedItem[t]))},reinitSize:function(t,e){var o=(t||800)-2,i=(e||500)-2;this.$bgDiv.css({height:i+"px",width:o+"px"});var a=0,s=10;null!=this.$head&&(a=24,s=7),null!=this.$tool&&this.$tool.css({height:i-a-s+"px"}),o-=39,i=i-a-(null!=this.$head?5:8),this.$workArea.parent().css({height:i+"px",width:o+"px"}),this.$workArea.css({height:3*i+"px",width:3*o+"px"}),""==GooFlow.prototype.useSVG&&(this.$draw.coordsize=3*o+","+3*i),this.$draw.style.width=3*o+"px",this.$draw.style.height=3*+i+"px",null==this.$group&&this.$group.css({height:3*i+"px",width:3*o+"px"})}},GooFlow.prototype.color={main:"#00B4E1",node:"#A1DCEB",line:"#3892D3",mark:"#ff3300",mix:"#B6F700",font:"#15428B"},jQuery.extend({createGooFlow:function(t,e){return new GooFlow(t,e)}});